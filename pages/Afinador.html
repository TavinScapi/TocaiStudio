<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!-- Meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Title -->
    <title>Afinador | Tocaí</title>

    <!-- Favicon -->
    <link rel="icon" href="../images/LogoTocaí.png" type="image/x-icon" sizes="32x32">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

    <!-- Icon Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="../css/afinador.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/footer.css">
    <link rel="stylesheet" href="../css/Menu-mobile.css">

    <!-- Scripts -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" defer></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js" defer></script>
    <script type="module" src="../js/load-components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://cdn.jsdelivr.net/npm/aubiojs@0.1.1/build/aubio.min.js"></script>

    <style>
        .note.in-tune {
            color: #27ae60 !important;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            font-weight: bold;
            scale: 1.15;
            z-index: 2;
        }

        .meter-pointer.in-tune {
            background: #27ae60 !important;
            transition: background 0.2s, box-shadow 0.2s;
        }
    </style>
</head>

<body>
    <canvas class="frequency-bars"></canvas>
    <div class="meter">
        <div class="meter-dot"></div>
        <div class="meter-pointer"></div>
    </div>
    <div class="notes">
        <div class="notes-list"></div>
        <div class="frequency">
            <span class="hz">Hz</span>
        </div>
    </div>
    <div class="a4">A<sub>4</sub> = <span>440</span> Hz</div>
    <label class="auto">
        Automático
        <input type="checkbox" checked />
    </label>

    <script>
        const Tuner = function (a4) {
            this.middleA = a4 || 440;
            this.semitone = 69;
            this.bufferSize = 4096;
            this.noteStrings = ["C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯", "A", "A♯", "B"];
            this.initGetUserMedia();
        };

        Tuner.prototype.initGetUserMedia = function () {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!window.AudioContext) return alert("AudioContext not supported");

            if (navigator.mediaDevices === undefined) navigator.mediaDevices = {};
            if (navigator.mediaDevices.getUserMedia === undefined) {
                navigator.mediaDevices.getUserMedia = function (constraints) {
                    const getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                    if (!getUserMedia) alert("getUserMedia is not implemented in this browser");
                    return new Promise((resolve, reject) => {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                };
            }
        };

        Tuner.prototype.startRecord = function () {
            const self = this;
            navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            }).then(function (stream) {
                self.audioContext.createMediaStreamSource(stream).connect(self.analyser);
                self.analyser.connect(self.scriptProcessor);
                self.scriptProcessor.connect(self.audioContext.destination);
                self.scriptProcessor.addEventListener("audioprocess", function (event) {
                    const frequency = self.pitchDetector.do(event.inputBuffer.getChannelData(0));
                    if (frequency && self.onNoteDetected) {
                        const note = self.getNote(frequency);
                        self.onNoteDetected({
                            name: self.noteStrings[note % 12],
                            value: note,
                            cents: self.getCents(frequency, note),
                            octave: parseInt(note / 12) - 1,
                            frequency: frequency,
                        });
                    }
                });
            }).catch(function (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Permissão negada',
                    text: 'Por favor, permita o acesso ao microfone para usar o afinador.'
                });
            });
        };

        Tuner.prototype.init = function () {
            this.audioContext = new window.AudioContext();
            this.analyser = this.audioContext.createAnalyser();
            this.scriptProcessor = this.audioContext.createScriptProcessor(this.bufferSize, 1, 1);
            const self = this;
            aubio().then(function (aubio) {
                self.pitchDetector = new aubio.Pitch("yin", self.bufferSize, 1, self.audioContext.sampleRate);
                self.startRecord();
            });
        };

        Tuner.prototype.getNote = function (frequency) {
            const note = 12 * (Math.log(frequency / this.middleA) / Math.log(2));
            return Math.round(note) + this.semitone;
        };

        Tuner.prototype.getStandardFrequency = function (note) {
            return this.middleA * Math.pow(2, (note - this.semitone) / 12);
        };

        Tuner.prototype.getCents = function (frequency, note) {
            return Math.floor(1200 * Math.log(frequency / this.getStandardFrequency(note)) / Math.log(2));
        };

        Tuner.prototype.play = function (frequency) {
            if (!this.oscillator) {
                this.oscillator = this.audioContext.createOscillator();
                this.oscillator.connect(this.audioContext.destination);
                this.oscillator.start();
            }
            this.oscillator.frequency.value = frequency;
        };

        Tuner.prototype.stopOscillator = function () {
            if (this.oscillator) {
                this.oscillator.stop();
                this.oscillator = null;
            }
        };

        const Application = function () {
            this.initA4();
            this.tuner = new Tuner(this.a4);
            this.notes = new Notes(".notes", this.tuner);
            this.meter = new Meter(".meter");
            this.frequencyBars = new FrequencyBars(".frequency-bars");
            this.recentFrequencies = [];
            this.maxHistory = 5;
            this.lastNote = null;
            this.lastUpdateTime = 0;
            this.update({ name: "A", frequency: this.a4, octave: 4, value: 69, cents: 0 });
        };

        Application.prototype.initA4 = function () {
            this.$a4 = document.querySelector(".a4 span");
            this.a4 = parseInt(localStorage.getItem("a4")) || 440;
            this.$a4.innerHTML = this.a4;
        };

        Application.prototype.start = function () {
            const self = this;

            this.tuner.onNoteDetected = function (note) {
                // Suavização por média móvel
                self.recentFrequencies.push(note.frequency);
                if (self.recentFrequencies.length > self.maxHistory) {
                    self.recentFrequencies.shift();
                }

                const avgFreq = self.recentFrequencies.reduce((a, b) => a + b, 0) / self.recentFrequencies.length;
                const value = self.tuner.getNote(avgFreq);

                const stableNote = {
                    name: self.tuner.noteStrings[value % 12],
                    value: value,
                    cents: self.tuner.getCents(avgFreq, value),
                    octave: parseInt(value / 12) - 1,
                    frequency: avgFreq
                };

                const now = performance.now();
                if (now - self.lastUpdateTime > 100) {
                    self.update(stableNote);
                    self.lastUpdateTime = now;
                }
            };

            self.tuner.init();
            self.frequencyData = new Uint8Array(self.tuner.analyser.frequencyBinCount);

            this.$a4.addEventListener("click", function () {
                Swal.fire({ input: "number", inputValue: self.a4 }).then(function ({ value: a4 }) {
                    if (!parseInt(a4) || a4 === self.a4) return;
                    self.a4 = a4;
                    self.$a4.innerHTML = a4;
                    self.tuner.middleA = a4;
                    self.notes.createNotes();
                    self.update({ name: "A", frequency: self.a4, octave: 4, value: 69, cents: 0 });
                    localStorage.setItem("a4", a4);
                });
            });

            document.querySelector(".auto input").addEventListener("change", () => {
                this.notes.toggleAutoMode();
            });

            this.updateFrequencyBars();
        };

        Application.prototype.updateFrequencyBars = function () {
            if (this.tuner.analyser) {
                this.tuner.analyser.getByteFrequencyData(this.frequencyData);
                this.frequencyBars.update(this.frequencyData);
            }
            requestAnimationFrame(this.updateFrequencyBars.bind(this));
        };

        Application.prototype.update = function (note) {
            this.notes.update(note);
            this.meter.update((note.cents / 50) * 45);
            const pointer = document.querySelector('.meter-pointer');
            if (Math.abs(note.cents) <= 5) {
                pointer.classList.add('in-tune');
            } else {
                pointer.classList.remove('in-tune');
            }
        };

        const app = new Application();
        app.start();
    </script>
</body>

</html>